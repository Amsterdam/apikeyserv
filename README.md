apikeyserv
==========

This program manages API keys for use by dataservices.

API keys are signed using this service's private key, so accepting services
only need this service's public key to confirm their validity, instead of
having to communicate with this service or its database.

The API keys are in JWT format so that services that deal with API keys can
use existing libraries for decoding them and verifying them against this
service's public key. They should *not* be used to perform authorization
checks beyond those that give access to public data. (This means that requests
for protected data from DSO-API or other services require two JWTs, one for
the API key and one in the Authorization header.)

Running:

    cd src
    pip install -r requirements.txt
    python manage.py makemigrations apikeys
    python manage.py migrate
    python manage.py createsuperuser  # Fill out the form
    python manage.py runserver
    # Generate a signing key:
    openssl genpkey -algorithm ED25519 -outform PEM

Now visit `http://localhost:8000/admin/` to add this signing key and start
adding API keys. Alternatively, a key can be added by piping the last command's
output through a management command:

    openssl genpkey -algorithm ED25519 -outform PEM |
        python manage.py addsigningkey /dev/stdin

apikeyserv can manage multiple signing keys to allow for key rotation.
Keys can be retired by unchecking their "active" flag.

Client services should check API keys against the public key(s) managed by
apikeyserv using PyJWT or another JWT library. They should periodically grab
the currently active keyset from apikeyserv's /signingkeys/ path, which serves
the active keys as a JSON Web Key Set (JWKS):

    >>> import jwt
    >>> from urllib.request import urlopen
    >>> response = urlopen("http://localhost:8000/signingkeys")
    >>> jwt.PyJWKSet.from_json(response.read())


Security and privacy
====================

API keys generated by this program do not contain personally identifying
information. Instead, they contain a numeric ID that is mapped to a name and
email address managed by apikeyserv.


Copyright 2022 Gemeente Amsterdam. All rights reserved.
